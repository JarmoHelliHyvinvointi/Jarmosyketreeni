<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Syketreeni v1.7.0</title>
    
    <style>
        /* --- CSS-osuus --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
        }

        /* --- MUUTOS: Palautettu yksinkertainen flexbox-rakenne --- */
        #main-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #canvas-wrapper {
            /* TÄÄLTÄ ON POISTETTU KAIKKI KOKOON LIITTYVÄT MÄÄRITYKSET. JAVASCRIPT HOITAA KAIKEN. */
            position: relative; 
        }
        
        #heartRateCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* --- MUUTOS PÄÄTTYY --- */

        #status-bar, #stats-container, #controls {
            flex-shrink: 0; /* Palkit eivät kutistu */
        }

        #status-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background-color: #1a1a1a;
            font-size: 1.2em;
        }
        
        #stats-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 15px 10px;
            background-color: #1a1a1a;
        }

        #hr-display { text-align: center; }
        #heartRateValue { font-size: 3.5em; font-weight: bold; color: #f44336; }
        .bpm-label { font-size: 1.2em; color: #ccc; display: block; margin-top: -10px; }
        #hr-zones { font-size: 1.5em; text-align: right; }
        #hr-max, #hr-min { margin: 5px 0; }
        
        #controls { padding: 20px; text-align: center; background-color: #1a1a1a; }
        #start-button { width: 80%; padding: 15px; font-size: 1.5em; font-weight: bold; background-color: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer; }
        
        #summary-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; }
        #summary-screen h2 { font-size: 2em; margin-bottom: 10px; }
        #summary-screen p { font-size: 1.2em; margin-bottom: 20px; }
        #summary-ok-button { padding: 15px 40px; font-size: 1.5em; background-color: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="status-bar">
            <div id="phase-name">Odottaa</div>
            <div id="timer">00:00</div>
        </div>

        <div id="canvas-wrapper">
            <canvas id="heartRateCanvas"></canvas>
        </div>
        
        <div id="stats-container">
            <div id="hr-display">
                <span id="heartRateValue">--</span>
                <span class="bpm-label">BPM</span>
            </div>
            <div id="hr-zones">
                <div id="hr-max">Max: <span id="maxHrValue">--</span></div>
                <div id="hr-min">Min: <span id="minHrValue">--</span></div>
            </div>
        </div>

        <div id="controls">
            <button id="start-button">Aloita Treeni</button>
        </div>
    </div>

    <div id="summary-screen">
        <h2 id="summary-title">Treeni Valmis!</h2>
        <p id="summary-text">Tässä yhteenveto treenistäsi.</p>
        <button id="summary-ok-button">OK</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvasWrapper = document.getElementById('canvas-wrapper');
            const canvas = document.getElementById('heartRateCanvas');
            const ctx = canvas.getContext('2d');
            
            const statusBar = document.getElementById('status-bar');
            const statsContainer = document.getElementById('stats-container');
            const controls = document.getElementById('controls');
            
            const startButton = document.getElementById('start-button');
            const heartRateValueEl = document.getElementById('heartRateValue');
            const phaseNameEl = document.getElementById('phase-name');
            const timerEl = document.getElementById('timer');
            const maxHrValueEl = document.getElementById('maxHrValue');
            const minHrValueEl = document.getElementById('minHrValue');
            
            const summaryScreen = document.getElementById('summary-screen');
            const summaryOkButton = document.getElementById('summary-ok-button');
            const mainContainer = document.getElementById('main-container');
            const summaryTitle = document.getElementById('summary-title');
            const summaryText = document.getElementById('summary-text');
            
            // ... (workoutPlan ja muut muuttujat ennallaan)
            const workoutPlan = [
                { name: 'Lämmittely', duration: 180, minHr: 100, maxHr: 120, color: 'rgba(255, 165, 0, 0.3)' },
                { name: 'Huippu 1', duration: 60, minHr: 140, maxHr: 160, color: 'rgba(255, 0, 0, 0.3)' },
                { name: 'Lepo 1', duration: 120, minHr: 110, maxHr: 130, color: 'rgba(0, 255, 0, 0.3)' },
                { name: 'Huippu 2', duration: 60, minHr: 140, maxHr: 160, color: 'rgba(255, 0, 0, 0.3)' },
                { name: 'Lepo 2', duration: 120, minHr: 110, maxHr: 130, color: 'rgba(0, 255, 0, 0.3)' },
                { name: 'Huippu 3', duration: 60, minHr: 140, maxHr: 160, color: 'rgba(255, 0, 0, 0.3)' },
                { name: 'Lepo 3', duration: 120, minHr: 110, maxHr: 130, color: 'rgba(0, 255, 0, 0.3)' },
                { name: 'Jäähdyttely', duration: 180, minHr: 90, maxHr: 110, color: 'rgba(0, 0, 255, 0.3)' },
            ];
            const totalWorkoutDuration = workoutPlan.reduce((acc, phase) => acc + phase.duration, 0);
            let heartRateData = [], workoutTimer, timeElapsed = 0, currentPhaseIndex = 0, animationFrameId, bluetoothDevice = null, bgRects = [];
            let isWorkoutRunning = false, isWorkoutFinished = false;
            const PIXELS_PER_SECOND = 10;
            // --- MUUTOKSET ALKAVAT TÄSTÄ ---

            function performLayout() {
                // Lasketaan palkkien näkyvät korkeudet. Jos treeni on käynnissä, 'controls' on piilossa.
                const statusBarHeight = statusBar.offsetHeight;
                const statsContainerHeight = statsContainer.offsetHeight;
                const controlsHeight = isWorkoutRunning ? 0 : controls.offsetHeight;

                // Lasketaan vapaa tila
                const availableHeight = window.innerHeight - statusBarHeight - statsContainerHeight - controlsHeight;

                // Asetetaan kääreen korkeus manuaalisesti
                canvasWrapper.style.height = `${availableHeight}px`;

                // Kutsutaan canvasin koonmuutosfunktiota VASTA kun kääre on oikean kokoinen
                resizeCanvas();
            }

            function resizeCanvas() {
                canvas.width = canvasWrapper.offsetWidth;
                canvas.height = canvasWrapper.offsetHeight;
                
                if (!isWorkoutRunning && !isWorkoutFinished) {
                    drawInitialOverview();
                } else if (isWorkoutRunning) {
                    // Treenin aikana piirto hoidetaan draw()-funktiossa
                }
            }
            
            function init() {
                performLayout(); // Asetetaan asettelu heti alussa
                window.addEventListener('resize', performLayout); // Ja aina kun ikkunan koko muuttuu
                startButton.addEventListener('click', startWorkout);
                summaryOkButton.addEventListener('click', () => location.reload());
            }

            async function startWorkout() {
                try {
                    // ... (koodi bluetooth-yhteyden luomiseen on ennallaan)
                    if (navigator.bluetooth == undefined) { throw new Error("Bluetooth ei tuettu"); }
                    const device = await navigator.bluetooth.requestDevice({ filters: [{ services: ['heart_rate'] }] });
                    const server = await device.gatt.connect();
                    const service = await server.getService('heart_rate');
                    const characteristic = await service.getCharacteristic('heart_rate_measurement');
                    characteristic.startNotifications();
                    characteristic.addEventListener('characteristicvaluechanged', handleHeartRate);
                    bluetoothDevice = device;
                    bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);

                    isWorkoutRunning = true;
                    document.getElementById('controls').style.display = 'none';
                    
                    performLayout(); // TÄRKEÄ: Suoritetaan asettelu uudelleen, kun nappi on piilotettu
                    
                    timeElapsed = 0;
                    currentPhaseIndex = 0;
                    heartRateData = [];
                    calculateBgRects();

                    workoutTimer = setInterval(updateWorkoutState, 1000);
                    updatePhaseDisplay();
                    draw();

                } catch (error) {
                    if (error.name !== 'NotFoundError') { alert(`Virhe: ${error.message}`); }
                    isWorkoutRunning = false; // Varmistetaan, että tila nollautuu
                    document.getElementById('controls').style.display = 'block'; // Näytetään nappi uudelleen
                    performLayout(); // Päivitetään asettelu
                }
            }

            // --- MUUTOKSET PÄÄTTYVÄT ---
            // Kaikki loput funktiot ovat ennallaan.
            
            function calculateBgRects(){ bgRects = []; let a = 0; workoutPlan.forEach(p => { bgRects.push({ startX: a * PIXELS_PER_SECOND, width: p.duration * PIXELS_PER_SECOND, color: p.color }); a += p.duration; }); }
            function drawInitialOverview(){ if(canvas.width===0||canvas.height===0)return; calculateBgRects(); const o=totalWorkoutDuration*PIXELS_PER_SECOND,s=canvas.width/o; ctx.clearRect(0,0,canvas.width,canvas.height); bgRects.forEach(r=>{ctx.fillStyle=r.color;ctx.fillRect(r.startX*s,0,r.width*s,canvas.height);}); workoutPlan.forEach((p,i)=>{let a=0;for(let k=0;k<i;k++)a+=workoutPlan[k].duration;const y=scaleY(p.minHr,canvas),m=scaleY(p.maxHr,canvas);ctx.fillStyle='rgba(255,255,255,0.5)';ctx.fillRect(a*PIXELS_PER_SECOND*s,y,p.duration*PIXELS_PER_SECOND*s,m-y);}); }
            function onDisconnected(){ if(isWorkoutRunning){stopWorkout(true);}}
            function handleHeartRate(e){const h=e.target.value.getUint8(1);heartRateValueEl.textContent=h;if(isWorkoutRunning){heartRateData.push({time:timeElapsed,hr:h});}}
            function updateWorkoutState(){timeElapsed++;updateTimerDisplay();if(timeElapsed>=totalWorkoutDuration){stopWorkout(false);return;}let a=0;for(let i=0;i<workoutPlan.length;i++){a+=workoutPlan[i].duration;if(timeElapsed<a){if(currentPhaseIndex!==i){currentPhaseIndex=i;updatePhaseDisplay();}break;}}}
            function stopWorkout(d){clearInterval(workoutTimer);isWorkoutRunning=false;isWorkoutFinished=true;cancelAnimationFrame(animationFrameId);if(bluetoothDevice){bluetoothDevice.removeEventListener('gattserverdisconnected',onDisconnected);if(bluetoothDevice.gatt.connected){bluetoothDevice.gatt.disconnect();}}mainContainer.style.display='none';summaryScreen.style.display='flex';if(d){summaryTitle.textContent="Yhteys katkesi";summaryText.textContent="Sykemittarin yhteys katkesi.";}const c=document.createElement('canvas');c.id='summaryCanvas';c.style.width='100%';c.style.flexGrow='1';c.style.minHeight='0';summaryScreen.insertBefore(c,summaryOkButton);setTimeout(()=>drawSummary(c),100);}
            function updatePhaseDisplay(){const p=workoutPlan[currentPhaseIndex];phaseNameEl.textContent=p.name;minHrValueEl.textContent=p.minHr;maxHrValueEl.textContent=p.maxHr;}
            function updateTimerDisplay(){const m=Math.floor(timeElapsed/60).toString().padStart(2,'0'),s=(timeElapsed%60).toString().padStart(2,'0');timerEl.textContent=`${m}:${s}`;}
            function scaleY(h,c){const t=c.height;if(t===0)return 0;const m=40,x=200;return t-((h-m)/(x-m))*t;}
            function draw(){if(!isWorkoutRunning)return;animationFrameId=requestAnimationFrame(draw);ctx.clearRect(0,0,canvas.width,canvas.height);const v=timeElapsed,s=v-(canvas.width/2/PIXELS_PER_SECOND);bgRects.forEach(r=>{const x=r.startX-(s*PIXELS_PER_SECOND);ctx.fillStyle=r.color;ctx.fillRect(x,0,r.width,canvas.height);});ctx.beginPath();ctx.lineWidth=2;let c=0;workoutPlan.forEach(p=>{const t=(c*PIXELS_PER_SECOND)-(s*PIXELS_PER_SECOND),e=((c+p.duration)*PIXELS_PER_SECOND)-(s*PIXELS_PER_SECOND);ctx.strokeStyle='rgba(255,255,0,0.8)';ctx.moveTo(t,scaleY(p.minHr,canvas));ctx.lineTo(e,scaleY(p.minHr,canvas));ctx.strokeStyle='rgba(255,0,0,0.8)';ctx.moveTo(t,scaleY(p.maxHr,canvas));ctx.lineTo(e,scaleY(p.maxHr,canvas));c+=p.duration;});ctx.stroke();if(heartRateData.length>1){ctx.beginPath();ctx.lineWidth=3;ctx.strokeStyle='#FFFFFF';let f=!1;for(let i=0;i<heartRateData.length;i++){const p=heartRateData[i],x=(p.time*PIXELS_PER_SECOND)-(s*PIXELS_PER_SECOND),y=scaleY(p.hr,canvas);if(x>-10&&x<canvas.width+10){if(!f){ctx.moveTo(x,y);f=!0;}else{ctx.lineTo(x,y);}}}ctx.stroke();}const n=canvas.width/2;ctx.strokeStyle='red';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(n,0);ctx.lineTo(n,canvas.height);ctx.stroke();}
            function drawSummary(c){c.width=c.offsetWidth;c.height=c.offsetHeight;const t=c.getContext('2d');if(c.width===0||c.height===0)return;t.clearRect(0,0,c.width,c.height);const s=c.width/totalWorkoutDuration;let a=0;workoutPlan.forEach(p=>{t.fillStyle=p.color;t.fillRect(a*s,0,p.duration*s,c.height);a+=p.duration;});t.beginPath();t.lineWidth=1.5;a=0;workoutPlan.forEach(p=>{const x=a*s,e=(a+p.duration)*s;t.strokeStyle='rgba(255,255,0,0.9)';t.moveTo(x,scaleY(p.minHr,c));t.lineTo(e,scaleY(p.minHr,c));t.strokeStyle='rgba(255,0,0,0.9)';t.moveTo(x,scaleY(p.maxHr,c));t.lineTo(e,scaleY(p.maxHr,c));a+=p.duration;});t.stroke();if(heartRateData.length>1){t.beginPath();t.lineWidth=2.5;t.strokeStyle='#FFFFFF';t.moveTo(heartRateData[0].time*s,scaleY(heartRateData[0].hr,c));for(let i=1;i<heartRateData.length;i++){t.lineTo(heartRateData[i].time*s,scaleY(heartRateData[i].hr,c));}t.stroke();}}

            init();
        });
    </script>
</body>
</html>