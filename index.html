<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Syketreeni v1.8.0 (Diagnostiikka)</title>
    
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: sans-serif; background-color: #000; color: #fff; overflow: hidden; }
        #main-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        #canvas-wrapper { position: relative; }
        #heartRateCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #status-bar, #stats-container, #controls { flex-shrink: 0; }
        #status-bar { display: flex; justify-content: space-between; padding: 10px 20px; background-color: #1a1a1a; font-size: 1.2em; }
        #stats-container { display: flex; justify-content: space-around; align-items: center; padding: 15px 10px; background-color: #1a1a1a; }
        #hr-display { text-align: center; }
        #heartRateValue { font-size: 3.5em; font-weight: bold; color: #f44336; }
        .bpm-label { font-size: 1.2em; color: #ccc; display: block; margin-top: -10px; }
        #hr-zones { font-size: 1.5em; text-align: right; }
        #hr-max, #hr-min { margin: 5px 0; }
        #controls { padding: 20px; text-align: center; background-color: #1a1a1a; }
        #start-button { width: 80%; padding: 15px; font-size: 1.5em; font-weight: bold; background-color: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer; }
        #summary-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; }
        #summary-screen h2 { font-size: 2em; margin-bottom: 10px; }
        #summary-screen p { font-size: 1.2em; margin-bottom: 20px; }
        #summary-ok-button { padding: 15px 40px; font-size: 1.5em; background-color: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer; }

        /* MUUTOS 1: Tyylit uudelle debug-paneelille */
        #debug-info {
            position: fixed;
            top: 50px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            color: black;
            padding: 10px;
            border: 2px solid red;
            z-index: 9999;
            font-size: 12px;
            pointer-events: none; /* Ei estä klikkauksia */
        }
    </style>
</head>
<body>
    <!-- MUUTOS 2: Lisätään debug-paneeli HTML-rakenteeseen -->
    <div id="debug-info">Odotetaan dataa...</div>

    <div id="main-container">
        <div id="status-bar">
            <div id="phase-name">Odottaa</div>
            <div id="timer">00:00</div>
        </div>
        <div id="canvas-wrapper">
            <canvas id="heartRateCanvas"></canvas>
        </div>
        <div id="stats-container">
            <div id="hr-display">
                <span id="heartRateValue">--</span>
                <span class="bpm-label">BPM</span>
            </div>
            <div id="hr-zones">
                <div id="hr-max">Max: <span id="maxHrValue">--</span></div>
                <div id="hr-min">Min: <span id="minHrValue">--</span></div>
            </div>
        </div>
        <div id="controls">
            <button id="start-button">Aloita Treeni</button>
        </div>
    </div>
    <div id="summary-screen">
        <h2 id="summary-title">Treeni Valmis!</h2>
        <p id="summary-text">Tässä yhteenveto treenistäsi.</p>
        <button id="summary-ok-button">OK</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const debugInfo = document.getElementById('debug-info'); // Haetaan debug-elementti
            const canvasWrapper = document.getElementById('canvas-wrapper');
            const canvas = document.getElementById('heartRateCanvas');
            const ctx = canvas.getContext('2d');
            const statusBar = document.getElementById('status-bar');
            const statsContainer = document.getElementById('stats-container');
            const controls = document.getElementById('controls');
            // ... muut elementit
            const startButton = document.getElementById('start-button');
            const heartRateValueEl = document.getElementById('heartRateValue');
            const phaseNameEl = document.getElementById('phase-name');
            const timerEl = document.getElementById('timer');
            const maxHrValueEl = document.getElementById('maxHrValue');
            const minHrValueEl = document.getElementById('minHrValue');
            const summaryScreen = document.getElementById('summary-screen');
            const summaryOkButton = document.getElementById('summary-ok-button');
            const mainContainer = document.getElementById('main-container');

            // ... workoutPlan ja muut muuttujat ennallaan

            // --- MUUTOS 3: PÄIVITETÄÄN ASETTELU- JA INIT-FUNKTIOT ---
            
            function performLayout() {
                const statusBarHeight = statusBar.offsetHeight;
                const statsContainerHeight = statsContainer.offsetHeight;
                const controlsHeight = controls.style.display === 'none' ? 0 : controls.offsetHeight;
                const windowHeight = window.innerHeight;

                const availableHeight = windowHeight - statusBarHeight - statsContainerHeight - controlsHeight;

                // Päivitetään debug-paneeli näillä arvoilla
                debugInfo.innerHTML = `
                    Ikkuna: ${windowHeight}px<br>
                    Yläpalkki: ${statusBarHeight}px<br>
                    Alapalkki: ${statsContainerHeight}px<br>
                    Nappi: ${controlsHeight}px<br>
                    <strong>Laskettu korkeus: ${availableHeight}px</strong>
                `;

                canvasWrapper.style.height = `${availableHeight}px`;
                resizeCanvas();
            }

            function resizeCanvas() {
                canvas.width = canvasWrapper.offsetWidth;
                canvas.height = canvasWrapper.offsetHeight;
                if (!isWorkoutRunning && !isWorkoutFinished) {
                    drawInitialOverview();
                }
            }
            
            function init() {
                // Annetaan selaimelle 100ms aikaa ennen mittausta
                setTimeout(performLayout, 100); 
                window.addEventListener('resize', performLayout);
                startButton.addEventListener('click', startWorkout);
                summaryOkButton.addEventListener('click', () => location.reload());
            }

            // KAIKKI LOPUT FUNKTIOT OVAT TÄYSIN ENNALLAAN
            const workoutPlan=[{name:'Lämmittely',duration:180,minHr:100,maxHr:120,color:'rgba(255, 165, 0, 0.3)'},{name:'Huippu 1',duration:60,minHr:140,maxHr:160,color:'rgba(255, 0, 0, 0.3)'},{name:'Lepo 1',duration:120,minHr:110,maxHr:130,color:'rgba(0, 255, 0, 0.3)'},{name:'Huippu 2',duration:60,minHr:140,maxHr:160,color:'rgba(255, 0, 0, 0.3)'},{name:'Lepo 2',duration:120,minHr:110,maxHr:130,color:'rgba(0, 255, 0, 0.3)'},{name:'Huippu 3',duration:60,minHr:140,maxHr:160,color:'rgba(255, 0, 0, 0.3)'},{name:'Lepo 3',duration:120,minHr:110,maxHr:130,color:'rgba(0, 255, 0, 0.3)'},{name:'Jäähdyttely',duration:180,minHr:90,maxHr:110,color:'rgba(0, 0, 255, 0.3)'},];const totalWorkoutDuration=workoutPlan.reduce((a,p)=>a+p.duration,0);let heartRateData=[],workoutTimer,timeElapsed=0,currentPhaseIndex=0,animationFrameId,bluetoothDevice=null,bgRects=[];let isWorkoutRunning=!1,isWorkoutFinished=!1;const PIXELS_PER_SECOND=10;async function startWorkout(){try{if(navigator.bluetooth==void 0)throw new Error("Bluetooth ei tuettu");const d=await navigator.bluetooth.requestDevice({filters:[{services:['heart_rate']}]}),s=await d.gatt.connect(),c=await s.getService('heart_rate'),h=await c.getCharacteristic('heart_rate_measurement');h.startNotifications(),h.addEventListener('characteristicvaluechanged',handleHeartRate),bluetoothDevice=d,bluetoothDevice.addEventListener('gattserverdisconnected',onDisconnected),isWorkoutRunning=!0,controls.style.display='none',performLayout(),timeElapsed=0,currentPhaseIndex=0,heartRateData=[],calculateBgRects(),workoutTimer=setInterval(updateWorkoutState,1000),updatePhaseDisplay(),draw()}catch(e){e.name!=='NotFoundError'&&alert(`Virhe: ${e.message}`),isWorkoutRunning=!1,controls.style.display='block',performLayout()}}function stopWorkout(d){clearInterval(workoutTimer),isWorkoutRunning=!1,isWorkoutFinished=!0,cancelAnimationFrame(animationFrameId),bluetoothDevice&&(bluetoothDevice.removeEventListener('gattserverdisconnected',onDisconnected),bluetoothDevice.gatt.connected&&bluetoothDevice.gatt.disconnect()),mainContainer.style.display='none',summaryScreen.style.display='flex',d&&(document.getElementById('summary-title').textContent="Yhteys katkesi",document.getElementById('summary-text').textContent="Sykemittarin yhteys katkesi.");const c=document.createElement('canvas');c.id='summaryCanvas',c.style.width='100%',c.style.flexGrow='1',c.style.minHeight='0',summaryScreen.insertBefore(c,document.getElementById('summary-ok-button')),setTimeout(()=>drawSummary(c),100)}function calculateBgRects(){bgRects=[];let a=0;workoutPlan.forEach(p=>{bgRects.push({startX:a*PIXELS_PER_SECOND,width:p.duration*PIXELS_PER_SECOND,color:p.color}),a+=p.duration})}function onDisconnected(){isWorkoutRunning&&stopWorkout(!0)}function handleHeartRate(e){const h=e.target.value.getUint8(1);heartRateValueEl.textContent=h,isWorkoutRunning&&heartRateData.push({time:timeElapsed,hr:h})}function updateWorkoutState(){timeElapsed++,updateTimerDisplay(),timeElapsed>=totalWorkoutDuration?(stopWorkout(!1),void 0):void function(){let a=0;for(let i=0;i<workoutPlan.length;i++)if(a+=workoutPlan[i].duration,timeElapsed<a){currentPhaseIndex!==i&&(currentPhaseIndex=i,updatePhaseDisplay());break}}()}function updatePhaseDisplay(){const p=workoutPlan[currentPhaseIndex];phaseNameEl.textContent=p.name,minHrValueEl.textContent=p.minHr,maxHrValueEl.textContent=p.maxHr}function updateTimerDisplay(){const m=Math.floor(timeElapsed/60).toString().padStart(2,'0'),s=(timeElapsed%60).toString().padStart(2,'0');timerEl.textContent=`${m}:${s}`}function scaleY(h,c){const t=c.height;if(t===0)return 0;const m=40,x=200;return t-((h-m)/(x-m))*t}function drawInitialOverview(){if(canvas.width===0||canvas.height===0)return;calculateBgRects();const o=totalWorkoutDuration*PIXELS_PER_SECOND,s=canvas.width/o;ctx.clearRect(0,0,canvas.width,canvas.height),bgRects.forEach(r=>{ctx.fillStyle=r.color,ctx.fillRect(r.startX*s,0,r.width*s,canvas.height)}),workoutPlan.forEach((p,i)=>{let a=0;for(let k=0;k<i;k++)a+=workoutPlan[k].duration;const y=scaleY(p.minHr,canvas),m=scaleY(p.maxHr,canvas);ctx.fillStyle='rgba(255,255,255,0.5)',ctx.fillRect(a*PIXELS_PER_SECOND*s,y,p.duration*PIXELS_PER_SECOND*s,m-y)})}function draw(){if(!isWorkoutRunning)return;animationFrameId=requestAnimationFrame(draw),ctx.clearRect(0,0,canvas.width,canvas.height);const v=timeElapsed,s=v-canvas.width/2/PIXELS_PER_SECOND;bgRects.forEach(r=>{const x=r.startX-s*PIXELS_PER_SECOND;ctx.fillStyle=r.color,ctx.fillRect(x,0,r.width,canvas.height)}),ctx.beginPath(),ctx.lineWidth=2;let c=0;workoutPlan.forEach(p=>{const t=(c*PIXELS_PER_SECOND)-s*PIXELS_PER_SECOND,e=(c+p.duration)*PIXELS_PER_SECOND-s*PIXELS_PER_SECOND;ctx.strokeStyle='rgba(255,255,0,0.8)',ctx.moveTo(t,scaleY(p.minHr,canvas)),ctx.lineTo(e,scaleY(p.minHr,canvas)),ctx.strokeStyle='rgba(255,0,0,0.8)',ctx.moveTo(t,scaleY(p.maxHr,canvas)),ctx.lineTo(e,scaleY(p.maxHr,canvas)),c+=p.duration}),ctx.stroke(),heartRateData.length>1&&(ctx.beginPath(),ctx.lineWidth=3,ctx.strokeStyle='#FFFFFF',function(){let f=!1;for(let i=0;i<heartRateData.length;i++){const p=heartRateData[i],x=p.time*PIXELS_PER_SECOND-s*PIXELS_PER_SECOND,y=scaleY(p.hr,canvas);x>-10&&x<canvas.width+10&&(f?(ctx.lineTo(x,y),void 0):(ctx.moveTo(x,y),f=!0))}}()),function(){const n=canvas.width/2;ctx.strokeStyle='red',ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(n,0),ctx.lineTo(n,canvas.height),ctx.stroke()}()}function drawSummary(c){c.width=c.offsetWidth,c.height=c.offsetHeight;const t=c.getContext('2d');if(c.width===0||c.height===0)return;t.clearRect(0,0,c.width,c.height);const s=c.width/totalWorkoutDuration;let a=0;workoutPlan.forEach(p=>{t.fillStyle=p.color,t.fillRect(a*s,0,p.duration*s,c.height),a+=p.duration}),t.beginPath(),t.lineWidth=1.5,a=0,workoutPlan.forEach(p=>{const x=a*s,e=(a+p.duration)*s;t.strokeStyle='rgba(255,255,0,0.9)',t.moveTo(x,scaleY(p.minHr,c)),t.lineTo(e,scaleY(p.minHr,c)),t.strokeStyle='rgba(255,0,0,0.9)',t.moveTo(x,scaleY(p.maxHr,c)),t.lineTo(e,scaleY(p.maxHr,c)),a+=p.duration}),t.stroke(),heartRateData.length>1&&(t.beginPath(),t.lineWidth=2.5,t.strokeStyle='#FFFFFF',t.moveTo(heartRateData[0].time*s,scaleY(heartRateData[0].hr,c)),function(){for(let i=1;i<heartRateData.length;i++)t.lineTo(heartRateData[i].time*s,scaleY(heartRateData[i].hr,c))}(),t.stroke())}

            init();
        });
    </script>
</body>
</html>